openapi: 3.0.3
info:
  title: AWS Billing Dashboard API
  description: |
    REST API for managing AWS billing accounts, transactions, and financial metrics.
    
    This API supports:
    - Payer Account management (AWS Organizations management accounts)
    - Usage Account management (AWS member accounts with discount configurations)
    - Transaction tracking (Usage, Credit/Deposit, Fee)
    - Dashboard metrics and analytics
    - Financial calculations with reseller/customer discounts
    
    ## Financial Logic
    
    The system implements a reseller discount model:
    - **Reseller Discount**: Applied to AWS usage costs
    - **Customer Discount**: Customer-facing discount (must be ≤ Reseller Discount)
    - **Net Cost**: Usage after reseller discount applied
    - **Final Cost**: Net cost + fees + credits (if rebate enabled)
    
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: https://api.billingdashboard.example.com/v1
    description: Production server
  - url: https://staging-api.billingdashboard.example.com/v1
    description: Staging server
  - url: http://localhost:3000/api
    description: Local development server

tags:
  - name: Payer Accounts
    description: Management of AWS Organizations payer (management) accounts
  - name: Usage Accounts
    description: Management of AWS member usage accounts with discount configurations
  - name: Transactions
    description: Financial transaction tracking and management
  - name: Dashboard
    description: Dashboard metrics and analytics
  - name: Validation
    description: Data validation and business rule checks

paths:
  /payer-accounts:
    get:
      tags:
        - Payer Accounts
      summary: List all payer accounts
      description: Retrieve a list of all registered AWS Organizations payer accounts
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number for pagination
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of items per page
        - in: query
          name: search
          schema:
            type: string
          description: Search by customer name or account ID
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PayerAccount'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    post:
      tags:
        - Payer Accounts
      summary: Register a new payer account
      description: Register a new AWS Organizations payer (management) account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePayerAccountRequest'
      responses:
        '201':
          description: Payer account created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/PayerAccount'
                  message:
                    type: string
                    example: Payer account registered successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Conflict - Account ID already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: 
                  code: DUPLICATE_ACCOUNT
                  message: A payer account with this ID already exists
        '500':
          $ref: '#/components/responses/InternalServerError'

  /payer-accounts/{accountId}:
    get:
      tags:
        - Payer Accounts
      summary: Get payer account details
      description: Retrieve details of a specific payer account by ID
      parameters:
        - $ref: '#/components/parameters/AccountId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/PayerAccount'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    put:
      tags:
        - Payer Accounts
      summary: Update payer account
      description: Update an existing payer account's information
      parameters:
        - $ref: '#/components/parameters/AccountId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePayerAccountRequest'
      responses:
        '200':
          description: Payer account updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/PayerAccount'
                  message:
                    type: string
                    example: Payer account updated successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    delete:
      tags:
        - Payer Accounts
      summary: Delete payer account
      description: Delete a payer account (only allowed if no associated usage accounts exist)
      parameters:
        - $ref: '#/components/parameters/AccountId'
      responses:
        '200':
          description: Payer account deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Payer account deleted successfully
        '400':
          description: Cannot delete - has associated usage accounts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error:
                  code: ACCOUNT_HAS_DEPENDENCIES
                  message: Cannot delete payer account with associated usage accounts
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /usage-accounts:
    get:
      tags:
        - Usage Accounts
      summary: List all usage accounts
      description: Retrieve a list of all AWS member usage accounts with their discount configurations
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: payerId
          schema:
            type: string
          description: Filter by payer account ID
        - in: query
          name: registered
          schema:
            type: boolean
          description: Filter by registration status
        - in: query
          name: search
          schema:
            type: string
          description: Search by customer name or account ID
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/UsageAccount'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    post:
      tags:
        - Usage Accounts
      summary: Register a new usage account
      description: Register a new AWS member usage account with discount configuration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUsageAccountRequest'
      responses:
        '201':
          description: Usage account created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UsageAccount'
                  message:
                    type: string
                    example: Usage account registered successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Conflict - Account ID already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /usage-accounts/{accountId}:
    get:
      tags:
        - Usage Accounts
      summary: Get usage account details
      description: Retrieve details of a specific usage account including discount configuration
      parameters:
        - $ref: '#/components/parameters/AccountId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UsageAccount'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    put:
      tags:
        - Usage Accounts
      summary: Update usage account
      description: Update usage account details and discount configuration
      parameters:
        - $ref: '#/components/parameters/AccountId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUsageAccountRequest'
      responses:
        '200':
          description: Usage account updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UsageAccount'
                  message:
                    type: string
                    example: Usage account updated successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    delete:
      tags:
        - Usage Accounts
      summary: Delete usage account
      description: Delete a usage account (only allowed if no associated transactions exist)
      parameters:
        - $ref: '#/components/parameters/AccountId'
      responses:
        '200':
          description: Usage account deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Usage account deleted successfully
        '400':
          description: Cannot delete - has associated transactions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /transactions:
    get:
      tags:
        - Transactions
      summary: List all transactions
      description: Retrieve a paginated list of all transactions with filtering and sorting options
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: type
          schema:
            type: string
            enum: [usage, credit, fee]
          description: Filter by transaction type
        - in: query
          name: usageAccountId
          schema:
            type: string
          description: Filter by usage account ID
        - in: query
          name: startDate
          schema:
            type: string
            format: date
          description: Filter transactions from this date (YYYY-MM-DD)
        - in: query
          name: endDate
          schema:
            type: string
            format: date
          description: Filter transactions until this date (YYYY-MM-DD)
        - in: query
          name: sortBy
          schema:
            type: string
            enum: [date, amount, type]
            default: date
          description: Sort field
        - in: query
          name: sortOrder
          schema:
            type: string
            enum: [asc, desc]
            default: desc
          description: Sort order
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
                  summary:
                    $ref: '#/components/schemas/TransactionSummary'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    post:
      tags:
        - Transactions
      summary: Create a new transaction
      description: Register a new financial transaction (usage, credit/deposit, or fee)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTransactionRequest'
      responses:
        '201':
          description: Transaction created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Transaction'
                  message:
                    type: string
                    example: Transaction registered successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: Usage account not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /transactions/{transactionId}:
    get:
      tags:
        - Transactions
      summary: Get transaction details
      description: Retrieve details of a specific transaction
      parameters:
        - in: path
          name: transactionId
          required: true
          schema:
            type: string
          description: Transaction ID
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Transaction'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    put:
      tags:
        - Transactions
      summary: Update transaction
      description: Update an existing transaction's details
      parameters:
        - in: path
          name: transactionId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTransactionRequest'
      responses:
        '200':
          description: Transaction updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Transaction'
                  message:
                    type: string
                    example: Transaction updated successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    delete:
      tags:
        - Transactions
      summary: Delete transaction
      description: Delete a transaction
      parameters:
        - in: path
          name: transactionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Transaction deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Transaction deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /dashboard/metrics:
    get:
      tags:
        - Dashboard
      summary: Get dashboard metrics
      description: Retrieve aggregated financial metrics for the dashboard
      parameters:
        - in: query
          name: period
          required: true
          schema:
            type: string
            enum: [current_month, last_month, last_3_months, last_6_months, last_12_months, ytd, custom]
          description: Time period for metrics calculation
        - in: query
          name: startDate
          schema:
            type: string
            format: date
          description: Start date for custom period (required if period=custom)
        - in: query
          name: endDate
          schema:
            type: string
            format: date
          description: End date for custom period (required if period=custom)
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/DashboardMetrics'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /dashboard/usage-breakdown:
    get:
      tags:
        - Dashboard
      summary: Get usage breakdown
      description: Retrieve usage breakdown by payer accounts and usage accounts
      parameters:
        - in: query
          name: period
          required: true
          schema:
            type: string
            enum: [current_month, last_month, last_3_months, last_6_months, last_12_months, ytd, custom]
        - in: query
          name: startDate
          schema:
            type: string
            format: date
        - in: query
          name: endDate
          schema:
            type: string
            format: date
        - in: query
          name: groupBy
          schema:
            type: string
            enum: [payer, usage]
            default: payer
          description: Group breakdown by payer or usage accounts
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UsageBreakdown'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /dashboard/discount-breakdown:
    get:
      tags:
        - Dashboard
      summary: Get discount breakdown
      description: Retrieve discount breakdown by payer accounts and usage accounts
      parameters:
        - in: query
          name: period
          required: true
          schema:
            type: string
            enum: [current_month, last_month, last_3_months, last_6_months, last_12_months, ytd, custom]
        - in: query
          name: startDate
          schema:
            type: string
            format: date
        - in: query
          name: endDate
          schema:
            type: string
            format: date
        - in: query
          name: groupBy
          schema:
            type: string
            enum: [payer, usage]
            default: payer
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/DiscountBreakdown'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /validate/discount-configuration:
    post:
      tags:
        - Validation
      summary: Validate discount configuration
      description: Validate that customer discount does not exceed reseller discount
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - resellerDiscount
                - customerDiscount
              properties:
                resellerDiscount:
                  type: number
                  format: double
                  minimum: 0
                  maximum: 100
                  description: Reseller discount percentage
                customerDiscount:
                  type: number
                  format: double
                  minimum: 0
                  maximum: 100
                  description: Customer discount percentage
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    description: Whether the configuration is valid
                  error:
                    type: string
                    nullable: true
                    description: Error message if invalid
              examples:
                valid:
                  value:
                    valid: true
                    error: null
                invalid:
                  value:
                    valid: false
                    error: Customer discount cannot exceed reseller discount
        '400':
          $ref: '#/components/responses/BadRequest'

components:
  parameters:
    AccountId:
      in: path
      name: accountId
      required: true
      schema:
        type: string
        pattern: '^\d{12}$'
      description: 12-digit AWS account ID

  schemas:
    PayerAccount:
      type: object
      required:
        - id
        - accountId
        - customerName
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          description: Internal unique identifier
        accountId:
          type: string
          pattern: '^\d{12}$'
          description: 12-digit AWS account ID
          example: "123456789012"
        customerName:
          type: string
          minLength: 1
          maxLength: 255
          description: Customer organization name
          example: "Acme Corporation"
        notes:
          type: string
          nullable: true
          maxLength: 1000
          description: Optional notes about the account
        usageAccountCount:
          type: integer
          minimum: 0
          description: Number of associated usage accounts
        createdAt:
          type: string
          format: date-time
          description: Account creation timestamp
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp

    CreatePayerAccountRequest:
      type: object
      required:
        - accountId
        - customerName
      properties:
        accountId:
          type: string
          pattern: '^\d{12}$'
          description: 12-digit AWS account ID
          example: "123456789012"
        customerName:
          type: string
          minLength: 1
          maxLength: 255
          description: Customer organization name
          example: "Acme Corporation"
        notes:
          type: string
          maxLength: 1000
          description: Optional notes about the account

    UpdatePayerAccountRequest:
      type: object
      properties:
        customerName:
          type: string
          minLength: 1
          maxLength: 255
          description: Customer organization name
        notes:
          type: string
          maxLength: 1000
          description: Optional notes about the account

    UsageAccount:
      type: object
      required:
        - id
        - accountId
        - customerName
        - payerId
        - payerAccountId
        - resellerDiscount
        - customerDiscount
        - rebateEnabled
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          description: Internal unique identifier
        accountId:
          type: string
          pattern: '^\d{12}$'
          description: 12-digit AWS account ID
          example: "987654321098"
        customerName:
          type: string
          minLength: 1
          maxLength: 255
          description: Customer name for this usage account
          example: "Acme Dev Team"
        payerId:
          type: string
          format: uuid
          description: Internal payer account ID reference
        payerAccountId:
          type: string
          pattern: '^\d{12}$'
          description: AWS payer account ID
        payerCustomerName:
          type: string
          description: Payer account customer name
        resellerDiscount:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: Reseller discount percentage (0-100)
          example: 15.5
        customerDiscount:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: Customer discount percentage (0-100, must be ≤ resellerDiscount)
          example: 10.0
        rebateEnabled:
          type: boolean
          description: Whether to apply rebate credits to total cost
          default: false
        notes:
          type: string
          nullable: true
          maxLength: 1000
          description: Optional notes about the account
        totalUsage:
          type: number
          format: double
          description: Total usage amount for this account
        totalCredits:
          type: number
          format: double
          description: Total credits amount for this account
        totalFees:
          type: number
          format: double
          description: Total fees amount for this account
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateUsageAccountRequest:
      type: object
      required:
        - accountId
        - customerName
        - payerAccountId
        - resellerDiscount
        - customerDiscount
      properties:
        accountId:
          type: string
          pattern: '^\d{12}$'
          description: 12-digit AWS account ID
          example: "987654321098"
        customerName:
          type: string
          minLength: 1
          maxLength: 255
          description: Customer name for this usage account
          example: "Acme Dev Team"
        payerAccountId:
          type: string
          pattern: '^\d{12}$'
          description: AWS payer account ID (must exist)
        resellerDiscount:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: Reseller discount percentage (0-100)
          example: 15.5
        customerDiscount:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: Customer discount percentage (0-100, must be ≤ resellerDiscount)
          example: 10.0
        rebateEnabled:
          type: boolean
          description: Whether to apply rebate credits to total cost
          default: false
        notes:
          type: string
          maxLength: 1000
          description: Optional notes about the account

    UpdateUsageAccountRequest:
      type: object
      properties:
        customerName:
          type: string
          minLength: 1
          maxLength: 255
        resellerDiscount:
          type: number
          format: double
          minimum: 0
          maximum: 100
        customerDiscount:
          type: number
          format: double
          minimum: 0
          maximum: 100
        rebateEnabled:
          type: boolean
        notes:
          type: string
          maxLength: 1000

    Transaction:
      type: object
      required:
        - id
        - type
        - usageAccountId
        - amount
        - date
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          description: Transaction unique identifier
        type:
          type: string
          enum: [usage, credit, fee]
          description: |
            Transaction type:
            - usage: AWS usage charges
            - credit: Credits or deposits (negative amount)
            - fee: Additional fees
        usageAccountId:
          type: string
          pattern: '^\d{12}$'
          description: Associated usage account ID
        usageAccountName:
          type: string
          description: Associated usage account customer name
        payerAccountId:
          type: string
          pattern: '^\d{12}$'
          description: Associated payer account ID
        payerCustomerName:
          type: string
          description: Associated payer customer name
        amount:
          type: number
          format: double
          description: Transaction amount in EUR (credits are negative)
          example: 1250.50
        date:
          type: string
          format: date
          description: Transaction date (YYYY-MM-DD)
          example: "2024-01-15"
        notes:
          type: string
          nullable: true
          maxLength: 1000
          description: Optional transaction notes
        resellerDiscount:
          type: number
          format: double
          description: Reseller discount % at time of transaction
        customerDiscount:
          type: number
          format: double
          description: Customer discount % at time of transaction
        rebateEnabled:
          type: boolean
          description: Whether rebate was enabled at time of transaction
        netCost:
          type: number
          format: double
          description: Calculated net cost after reseller discount
        finalCost:
          type: number
          format: double
          description: Calculated final cost (usage + fee + applicable credits)
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateTransactionRequest:
      type: object
      required:
        - type
        - usageAccountId
        - amount
        - date
      properties:
        type:
          type: string
          enum: [usage, credit, fee]
          description: Transaction type
        usageAccountId:
          type: string
          pattern: '^\d{12}$'
          description: Usage account ID (must exist)
        amount:
          type: number
          format: double
          description: Transaction amount (use negative for credits)
          example: 1250.50
        date:
          type: string
          format: date
          description: Transaction date (YYYY-MM-DD)
          example: "2024-01-15"
        notes:
          type: string
          maxLength: 1000
          description: Optional transaction notes

    UpdateTransactionRequest:
      type: object
      properties:
        type:
          type: string
          enum: [usage, credit, fee]
        amount:
          type: number
          format: double
        date:
          type: string
          format: date
        notes:
          type: string
          maxLength: 1000

    TransactionSummary:
      type: object
      properties:
        totalUsage:
          type: number
          format: double
          description: Sum of all usage transactions
        totalCredits:
          type: number
          format: double
          description: Sum of all credit transactions (negative)
        totalFees:
          type: number
          format: double
          description: Sum of all fee transactions
        totalNetCost:
          type: number
          format: double
          description: Sum of all net costs
        totalFinalCost:
          type: number
          format: double
          description: Sum of all final costs
        transactionCount:
          type: integer
          description: Total number of transactions

    DashboardMetrics:
      type: object
      properties:
        period:
          type: object
          properties:
            start:
              type: string
              format: date
            end:
              type: string
              format: date
            label:
              type: string
              example: "January 2024"
        usage:
          type: object
          properties:
            total:
              type: number
              format: double
              description: Total usage amount
            byPayer:
              type: array
              items:
                type: object
                properties:
                  payerAccountId:
                    type: string
                  customerName:
                    type: string
                  amount:
                    type: number
                    format: double
                  percentage:
                    type: number
                    format: double
            topUsageAccounts:
              type: array
              items:
                type: object
                properties:
                  accountId:
                    type: string
                  customerName:
                    type: string
                  amount:
                    type: number
                    format: double
        discounts:
          type: object
          properties:
            totalResellerDiscount:
              type: number
              format: double
            totalCustomerDiscount:
              type: number
              format: double
            byPayer:
              type: array
              items:
                type: object
                properties:
                  payerAccountId:
                    type: string
                  customerName:
                    type: string
                  resellerDiscount:
                    type: number
                    format: double
                  customerDiscount:
                    type: number
                    format: double
            byUsageAccount:
              type: array
              items:
                type: object
                properties:
                  accountId:
                    type: string
                  customerName:
                    type: string
                  resellerDiscount:
                    type: number
                    format: double
                  customerDiscount:
                    type: number
                    format: double
        transactions:
          type: object
          properties:
            totalUsage:
              type: number
              format: double
            totalCredits:
              type: number
              format: double
            totalFees:
              type: number
              format: double
            totalNetCost:
              type: number
              format: double
            totalFinalCost:
              type: number
              format: double
            count:
              type: integer
            latest:
              type: array
              items:
                $ref: '#/components/schemas/Transaction'
              maxItems: 10

    UsageBreakdown:
      type: object
      properties:
        total:
          type: number
          format: double
        breakdown:
          type: array
          items:
            type: object
            properties:
              accountId:
                type: string
              customerName:
                type: string
              amount:
                type: number
                format: double
              percentage:
                type: number
                format: double
              transactionCount:
                type: integer

    DiscountBreakdown:
      type: object
      properties:
        totalResellerDiscount:
          type: number
          format: double
        totalCustomerDiscount:
          type: number
          format: double
        breakdown:
          type: array
          items:
            type: object
            properties:
              accountId:
                type: string
              customerName:
                type: string
              resellerDiscount:
                type: number
                format: double
              customerDiscount:
                type: number
                format: double
              usageAmount:
                type: number
                format: double

    Pagination:
      type: object
      properties:
        page:
          type: integer
          minimum: 1
          description: Current page number
        limit:
          type: integer
          minimum: 1
          description: Items per page
        total:
          type: integer
          minimum: 0
          description: Total number of items
        totalPages:
          type: integer
          minimum: 0
          description: Total number of pages
        hasNext:
          type: boolean
          description: Whether there is a next page
        hasPrevious:
          type: boolean
          description: Whether there is a previous page

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Error code for programmatic handling
              example: VALIDATION_ERROR
            message:
              type: string
              description: Human-readable error message
              example: Invalid input provided
            details:
              type: object
              description: Additional error details
              additionalProperties: true

  responses:
    BadRequest:
      description: Bad request - Invalid input
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            validation:
              value:
                error:
                  code: VALIDATION_ERROR
                  message: Invalid input provided
                  details:
                    field: accountId
                    issue: Must be a 12-digit number
            businessRule:
              value:
                error:
                  code: BUSINESS_RULE_VIOLATION
                  message: Customer discount cannot exceed reseller discount
                  details:
                    resellerDiscount: 10.0
                    customerDiscount: 15.0

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error:
              code: NOT_FOUND
              message: The requested resource was not found

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error:
              code: INTERNAL_ERROR
              message: An unexpected error occurred

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from authentication endpoint

security:
  - BearerAuth: []

openapi: 3.0.3
info:
  title: AWS Billing Dashboard - Exchange Rate API
  description: |
    API specification for exchange rate configuration and management.
    
    **Workflow:**
    1. User selects a Payer Account
    2. System displays all exchange rates configured for that account
    3. User can add new exchange rates for new billing periods
    4. User can update existing exchange rates for specific billing periods
    5. User can apply exchange rates to recalculate transactions
  version: 1.1.0
  contact:
    name: API Support

servers:
  - url: https://qwvzcttk3b.execute-api.eu-west-1.amazonaws.com/dev
    description: AWS API Gateway - Development
  - url: https://api.example.com/v1
    description: Production server
  - url: http://localhost:3001/v1
    description: Development server

paths:
  /settings/exchange-rates:
    get:
      summary: List exchange rate configurations
      description: |
        Retrieve exchange rate configurations with optional filtering by payer account.
        Results are typically sorted by billing period in descending order.
      tags:
        - Exchange Rates
      parameters:
        - name: payerAccountId
          in: query
          description: Filter by payer account ID (12 digits)
          required: false
          schema:
            type: string
            pattern: '^\d{12}$'
          example: '123456789012'
        - name: billingPeriod
          in: query
          description: Filter by billing period (YYYY-MM format)
          required: false
          schema:
            type: string
            pattern: '^\d{4}-\d{2}$'
          example: '2025-01'
      responses:
        '200':
          description: List of exchange rate configurations
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ExchangeRateConfig'
              example:
                data:
                  - id: 'exr-abc123'
                    payerAccountId: '123456789012'
                    payerAccountName: 'AWS Main Account'
                    billingPeriod: '2025-01'
                    exchangeRate: 1.093
                    createdAt: '2025-01-10T10:00:00Z'
                    updatedAt: '2025-01-15T14:30:00Z'
                  - id: 'exr-def456'
                    payerAccountId: '123456789012'
                    payerAccountName: 'AWS Main Account'
                    billingPeriod: '2024-12'
                    exchangeRate: 1.085
                    createdAt: '2024-12-01T10:00:00Z'
                    updatedAt: '2024-12-01T10:00:00Z'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      summary: Create new exchange rate configuration
      description: |
        Create a new exchange rate configuration for a specific payer account and billing period.
        The combination of payerAccountId and billingPeriod must be unique.
      tags:
        - Exchange Rates
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateExchangeRate'
            example:
              payerAccountId: '123456789012'
              billingPeriod: '2025-02'
              exchangeRate: 1.095
      responses:
        '201':
          description: Exchange rate configuration created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExchangeRateConfig'
              example:
                id: 'exr-xyz789'
                payerAccountId: '123456789012'
                payerAccountName: 'AWS Main Account'
                billingPeriod: '2025-02'
                exchangeRate: 1.095
                createdAt: '2025-01-20T10:00:00Z'
                updatedAt: '2025-01-20T10:00:00Z'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Configuration already exists for this period
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: 'ConflictError'
                message: 'An exchange rate for this billing period already exists. Please edit it instead.'
                details:
                  payerAccountId: '123456789012'
                  billingPeriod: '2025-01'
        '500':
          $ref: '#/components/responses/InternalError'

  /settings/exchange-rates/{id}:
    get:
      summary: Get exchange rate configuration by ID
      description: Retrieve a specific exchange rate configuration by its unique identifier
      tags:
        - Exchange Rates
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          example: 'exr-abc123'
      responses:
        '200':
          description: Exchange rate configuration details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExchangeRateConfig'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    put:
      summary: Update exchange rate configuration
      description: |
        Update the exchange rate value for an existing configuration.
        Note: payerAccountId and billingPeriod cannot be changed after creation.
      tags:
        - Exchange Rates
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          example: 'exr-abc123'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateExchangeRate'
            example:
              exchangeRate: 1.098
      responses:
        '200':
          description: Exchange rate configuration updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExchangeRateConfig'
              example:
                id: 'exr-abc123'
                payerAccountId: '123456789012'
                payerAccountName: 'AWS Main Account'
                billingPeriod: '2025-01'
                exchangeRate: 1.098
                createdAt: '2025-01-10T10:00:00Z'
                updatedAt: '2025-01-20T15:45:00Z'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      summary: Delete exchange rate configuration
      description: Delete an exchange rate configuration. This does not affect previously calculated transactions.
      tags:
        - Exchange Rates
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          example: 'exr-abc123'
      responses:
        '204':
          description: Exchange rate configuration deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /settings/exchange-rates/{id}/apply:
    post:
      summary: Apply exchange rate to recalculate transactions
      description: |
        Apply the configured exchange rate to recalculate all transactions for the specified billing period.
        This updates all transaction currency conversions (USD to EUR) for the payer account and billing period.
        
        **Important:** This operation may take several seconds for large transaction volumes.
      tags:
        - Exchange Rates
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          example: 'exr-abc123'
      responses:
        '200':
          description: Exchange rate applied and transactions recalculated successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - message
                  - affectedTransactions
                  - billingPeriod
                  - payerAccountId
                properties:
                  message:
                    type: string
                    example: 'Exchange rate applied successfully'
                  affectedTransactions:
                    type: integer
                    description: Number of transactions that were recalculated
                    example: 150
                  billingPeriod:
                    type: string
                    pattern: '^\d{4}-\d{2}$'
                    example: '2025-01'
                  payerAccountId:
                    type: string
                    pattern: '^\d{12}$'
                    example: '123456789012'
                  exchangeRate:
                    type: number
                    format: double
                    example: 1.093
              example:
                message: 'All transactions have been recalculated successfully'
                affectedTransactions: 150
                billingPeriod: '2025-01'
                payerAccountId: '123456789012'
                exchangeRate: 1.093
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  schemas:
    ExchangeRateConfig:
      type: object
      required:
        - id
        - payerAccountId
        - payerAccountName
        - billingPeriod
        - exchangeRate
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          description: Unique identifier for the exchange rate configuration
          example: 'exr-abc123'
        payerAccountId:
          type: string
          pattern: '^\d{12}$'
          description: AWS payer account ID (12 digits)
          example: '123456789012'
        payerAccountName:
          type: string
          description: Name of the payer account
          example: 'AWS Main Account'
        billingPeriod:
          type: string
          pattern: '^\d{4}-\d{2}$'
          description: Billing period in YYYY-MM format
          example: '2025-01'
        exchangeRate:
          type: number
          format: double
          minimum: 0
          exclusiveMinimum: true
          description: Exchange rate from USD to EUR (must be greater than 0)
          example: 1.093
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the configuration was created
          example: '2025-01-10T10:00:00Z'
        updatedAt:
          type: string
          format: date-time
          description: Timestamp when the configuration was last updated
          example: '2025-01-15T14:30:00Z'

    CreateExchangeRate:
      type: object
      required:
        - payerAccountId
        - billingPeriod
        - exchangeRate
      properties:
        payerAccountId:
          type: string
          pattern: '^\d{12}$'
          description: AWS payer account ID (12 digits)
          example: '123456789012'
        billingPeriod:
          type: string
          pattern: '^\d{4}-\d{2}$'
          description: Billing period in YYYY-MM format
          example: '2025-01'
        exchangeRate:
          type: number
          format: double
          minimum: 0
          exclusiveMinimum: true
          description: Exchange rate from USD to EUR (must be greater than 0)
          example: 1.093

    UpdateExchangeRate:
      type: object
      required:
        - exchangeRate
      properties:
        exchangeRate:
          type: number
          format: double
          minimum: 0
          exclusiveMinimum: true
          description: Updated exchange rate from USD to EUR (must be greater than 0)
          example: 1.095

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error type/code
          example: 'ValidationError'
        message:
          type: string
          description: Human-readable error message
          example: 'Invalid exchange rate value'
        details:
          type: object
          description: Additional error details (optional)
          additionalProperties: true

  responses:
    BadRequest:
      description: Bad request - Invalid input parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: 'ValidationError'
            message: 'Invalid exchange rate value'
            details:
              field: 'exchangeRate'
              value: '-1.5'
              constraint: 'Must be greater than 0'
    
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: 'NotFoundError'
            message: 'Exchange rate configuration not found'
            details:
              id: 'exr-abc123'
    
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: 'InternalServerError'
            message: 'An unexpected error occurred'

tags:
  - name: Exchange Rates
    description: |
      Exchange rate configuration management for billing periods.
      
      **Key Features:**
      - Configure exchange rates per payer account and billing period
      - Update existing configurations
      - Apply rates to recalculate transaction currency conversions
      - Prevent duplicate configurations for the same period

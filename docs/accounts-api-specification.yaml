openapi: 3.0.3
info:
  title: AWS Billing Dashboard - Accounts API
  description: |
    API specification for managing Payer Accounts and Usage Accounts in the AWS Billing Dashboard system.
    
    This API focuses exclusively on account management operations:
    - **Payer Accounts**: AWS Organizations payer (management) accounts with distributor information
    - **Usage Accounts**: AWS member usage accounts with discount configurations and financial settings
    
    ## Account Status Workflows
    - **Payer Account**: Registered → Archived
    - **Usage Account**: Unregistered → Registered → Archived
    
    ## UI Button Actions by Status
    
    ### Payer Account Actions:
    - **Registered/Active**: Edit, Archive
    - **Archived**: Unarchive, Delete
    
    ### Usage Account Actions:
    - **Unregistered**: Register
    - **Registered/Active**: Edit, Details, Archive
    - **Archived**: Unarchive, Delete
    
  version: 1.1.0
  contact:
    name: API Support
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.billing.example.com/v1
    description: Production server
  - url: https://staging-api.billing.example.com/v1
    description: Staging server
  - url: http://localhost:3000/api/v1
    description: Local development server

tags:
  - name: Payer Accounts
    description: Management of AWS Organizations payer (management) accounts
  - name: Usage Accounts
    description: Management of AWS member usage accounts with discount configurations

paths:
  /payer-accounts:
    get:
      tags:
        - Payer Accounts
      summary: List all payer accounts
      description: Retrieve a paginated list of all payer accounts with filtering and search capabilities
      operationId: listPayerAccounts
      parameters:
        - name: page
          in: query
          description: Page number for pagination
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: Number of items per page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: status
          in: query
          description: Filter by account status
          schema:
            type: string
            enum: [Registered, Archived]
        - name: search
          in: query
          description: Search by account name, account ID, or distributor name
          schema:
            type: string
            minLength: 1
      responses:
        '200':
          description: Successful response with list of payer accounts
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PayerAccount'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    post:
      tags:
        - Payer Accounts
      summary: Register a new payer account
      description: Register a new AWS Organizations payer (management) account with complete configuration
      operationId: createPayerAccount
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePayerAccountRequest'
      responses:
        '201':
          description: Payer account registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/PayerAccount'
                  message:
                    type: string
                    example: "Payer account registered successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Conflict - Account ID already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error:
                  code: "DUPLICATE_ACCOUNT_ID"
                  message: "A payer account with this Account ID already exists"
                  field: "accountId"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /payer-accounts/{accountId}:
    get:
      tags:
        - Payer Accounts
      summary: Get payer account details
      description: Retrieve complete details of a specific payer account
      operationId: getPayerAccount
      parameters:
        - $ref: '#/components/parameters/AccountId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/PayerAccount'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    put:
      tags:
        - Payer Accounts
      summary: Update payer account
      description: |
        Update an existing payer account's configuration.
        Note: Account ID and Account Name cannot be modified after creation.
      operationId: updatePayerAccount
      parameters:
        - $ref: '#/components/parameters/AccountId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePayerAccountRequest'
      responses:
        '200':
          description: Payer account updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/PayerAccount'
                  message:
                    type: string
                    example: "Payer account updated successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    delete:
      tags:
        - Payer Accounts
      summary: Delete payer account
      description: |
        Permanently delete a payer account. Only archived accounts can be deleted.
        This operation cannot be undone.
      operationId: deletePayerAccount
      parameters:
        - $ref: '#/components/parameters/AccountId'
      responses:
        '204':
          description: Payer account deleted successfully (no content)
        '400':
          description: Bad request - cannot delete active account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error:
                  code: "CANNOT_DELETE_ACTIVE_ACCOUNT"
                  message: "Cannot delete a payer account with status 'Registered'. Archive it first."
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /payer-accounts/{accountId}/status:
    patch:
      tags:
        - Payer Accounts
      summary: Change payer account status
      description: |
        Archive or unarchive a payer account.
        - Archive: Changes status from "Registered" to "Archived"
        - Unarchive: Changes status from "Archived" to "Registered"
      operationId: changePayerAccountStatus
      parameters:
        - $ref: '#/components/parameters/AccountId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [Registered, Archived]
                  description: New status for the payer account
      responses:
        '200':
          description: Payer account status changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/PayerAccount'
                  message:
                    type: string
                    example: "Payer account archived successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /usage-accounts:
    get:
      tags:
        - Usage Accounts
      summary: List all usage accounts
      description: Retrieve a paginated list of all usage accounts with filtering capabilities
      operationId: listUsageAccounts
      parameters:
        - name: page
          in: query
          description: Page number for pagination
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: Number of items per page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: payerAccountId
          in: query
          description: Filter by parent payer account ID
          schema:
            type: string
            pattern: '^\d{12}$'
        - name: status
          in: query
          description: Filter by account status
          schema:
            type: string
            enum: [Unregistered, Registered, Archived]
        - name: search
          in: query
          description: Search by customer name or account ID
          schema:
            type: string
            minLength: 1
      responses:
        '200':
          description: Successful response with list of usage accounts
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/UsageAccount'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    post:
      tags:
        - Usage Accounts
      summary: Register a new usage account
      description: |
        Register a new AWS member usage account with financial configuration.
        Customer discount must not exceed reseller discount.
      operationId: createUsageAccount
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUsageAccountRequest'
      responses:
        '201':
          description: Usage account registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UsageAccount'
                  message:
                    type: string
                    example: "Usage account registered successfully"
        '400':
          description: Bad request - validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                discountValidation:
                  summary: Customer discount exceeds reseller discount
                  value:
                    error:
                      code: "INVALID_DISCOUNT_CONFIGURATION"
                      message: "Customer discount cannot exceed Reseller discount"
                      field: "customerDiscount"
        '404':
          description: Payer account not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error:
                  code: "PAYER_ACCOUNT_NOT_FOUND"
                  message: "The specified payer account does not exist"
                  field: "payerAccountId"
        '409':
          description: Conflict - Account ID already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /usage-accounts/{accountId}:
    get:
      tags:
        - Usage Accounts
      summary: Get usage account details
      description: Retrieve complete details of a specific usage account including financial configuration
      operationId: getUsageAccount
      parameters:
        - $ref: '#/components/parameters/AccountId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UsageAccount'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    put:
      tags:
        - Usage Accounts
      summary: Update usage account
      description: |
        Update usage account's financial configuration.
        Note: Account ID and Customer Name cannot be modified after creation.
        Customer discount must not exceed reseller discount.
      operationId: updateUsageAccount
      parameters:
        - $ref: '#/components/parameters/AccountId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUsageAccountRequest'
      responses:
        '200':
          description: Usage account updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UsageAccount'
                  message:
                    type: string
                    example: "Usage account updated successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    delete:
      tags:
        - Usage Accounts
      summary: Delete usage account
      description: |
        Permanently delete a usage account. Only archived accounts can be deleted.
        This operation cannot be undone.
      operationId: deleteUsageAccount
      parameters:
        - $ref: '#/components/parameters/AccountId'
      responses:
        '204':
          description: Usage account deleted successfully (no content)
        '400':
          description: Bad request - cannot delete non-archived account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error:
                  code: "CANNOT_DELETE_NON_ARCHIVED_ACCOUNT"
                  message: "Cannot delete a usage account unless it is archived"
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /usage-accounts/{accountId}/status:
    patch:
      tags:
        - Usage Accounts
      summary: Change usage account status
      description: |
        Change usage account status through the workflow:
        - Register: Unregistered → Registered
        - Archive: Registered → Archived
        - Unarchive: Archived → Registered
      operationId: changeUsageAccountStatus
      parameters:
        - $ref: '#/components/parameters/AccountId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [Registered, Archived]
                  description: New status (cannot change to Unregistered)
      responses:
        '200':
          description: Usage account status updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UsageAccount'
                  message:
                    type: string
                    example: "Usage account status updated successfully"
        '400':
          description: Invalid status transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error:
                  code: "INVALID_STATUS_TRANSITION"
                  message: "Cannot transition from current status to requested status"
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  parameters:
    AccountId:
      name: accountId
      in: path
      required: true
      description: 12-digit AWS account ID
      schema:
        type: string
        pattern: '^\d{12}$'
      example: "123456789012"

  schemas:
    PayerAccount:
      type: object
      required:
        - id
        - accountId
        - accountName
        - distributorName
        - legalEntityName
        - vatNumber
        - crossAccountRoleArn
        - status
        - usageAccountCount
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          description: Internal unique identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        accountId:
          type: string
          pattern: '^\d{12}$'
          description: 12-digit AWS payer account ID
          example: "123456789012"
        accountName:
          type: string
          minLength: 1
          maxLength: 255
          description: Payer account name
          example: "Production Payer"
        distributorName:
          type: string
          minLength: 1
          maxLength: 255
          description: Name of the AWS distributor
          example: "AWS Distributor Inc."
        legalEntityName:
          type: string
          minLength: 1
          maxLength: 255
          description: Legal entity name of the MSP/Partner managing this payer account
          example: "AWS Distributor Legal Entity Ltd."
        vatNumber:
          type: string
          minLength: 1
          maxLength: 50
          description: VAT identification number
          example: "DE123456789"
        crossAccountRoleArn:
          type: string
          minLength: 1
          maxLength: 500
          description: AWS IAM Role ARN required for parquet file processing from your AWS account
          example: "arn:aws:iam::123456789012:role/BillingDataAccessRole"
        status:
          type: string
          enum: [Registered, Archived]
          description: Account status (Registered → Archived)
          example: "Registered"
        lastTransactionDate:
          type: string
          format: date-time
          nullable: true
          description: Date and time of the last transaction
          example: "2025-01-15T10:30:00Z"
        usageAccountCount:
          type: integer
          minimum: 0
          description: Number of associated usage accounts
          example: 5
        createdAt:
          type: string
          format: date-time
          description: Account creation timestamp
          example: "2024-01-10T09:00:00Z"
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp
          example: "2025-01-15T10:30:00Z"

    CreatePayerAccountRequest:
      type: object
      required:
        - accountId
        - accountName
        - distributorName
        - legalEntityName
        - vatNumber
        - crossAccountRoleArn
      properties:
        accountId:
          type: string
          pattern: '^\d{12}$'
          description: 12-digit AWS payer account ID (must be unique)
          example: "123456789012"
        accountName:
          type: string
          minLength: 1
          maxLength: 255
          description: Payer account name
          example: "Production Payer"
        distributorName:
          type: string
          minLength: 1
          maxLength: 255
          description: Name of the AWS distributor
          example: "AWS Distributor Inc."
        legalEntityName:
          type: string
          minLength: 1
          maxLength: 255
          description: Legal entity name of the MSP/Partner managing this payer account
          example: "AWS Distributor Legal Entity Ltd."
        vatNumber:
          type: string
          minLength: 1
          maxLength: 50
          description: VAT identification number
          example: "DE123456789"
        crossAccountRoleArn:
          type: string
          minLength: 1
          maxLength: 500
          description: AWS IAM Role ARN required for parquet file processing
          example: "arn:aws:iam::123456789012:role/BillingDataAccessRole"

    UpdatePayerAccountRequest:
      type: object
      description: |
        Update payer account configuration.
        Note: accountId and accountName cannot be modified.
      properties:
        distributorName:
          type: string
          minLength: 1
          maxLength: 255
          description: Name of the AWS distributor
        legalEntityName:
          type: string
          minLength: 1
          maxLength: 255
          description: Legal entity name of the MSP/Partner
        vatNumber:
          type: string
          minLength: 1
          maxLength: 50
          description: VAT identification number
        crossAccountRoleArn:
          type: string
          minLength: 1
          maxLength: 500
          description: AWS IAM Role ARN

    UsageAccount:
      type: object
      required:
        - id
        - accountId
        - customer
        - status
        - payerAccountId
        - vatNumber
        - resellerDiscount
        - customerDiscount
        - rebateCredits
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          description: Internal unique identifier
          example: "660e8400-e29b-41d4-a716-446655440001"
        accountId:
          type: string
          pattern: '^\d{12}$'
          description: 12-digit AWS usage account ID
          example: "987654321098"
        customer:
          type: string
          minLength: 1
          maxLength: 255
          description: Customer name for this usage account
          example: "Acme Corporation"
        status:
          type: string
          enum: [Unregistered, Registered, Archived]
          description: Account status (Unregistered → Registered → Archived)
          example: "Registered"
        payerAccountId:
          type: string
          pattern: '^\d{12}$'
          description: Parent AWS payer account ID
          example: "123456789012"
        distributorName:
          type: string
          description: Name of the distributor (inherited from payer account)
          example: "AWS Distributor Inc."
        vatNumber:
          type: string
          minLength: 1
          maxLength: 50
          description: VAT identification number
          example: "DE123456789"
        resellerDiscount:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: Reseller discount percentage (0-100)
          example: 15.5
        customerDiscount:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: Customer discount percentage (0-100, must be ≤ resellerDiscount)
          example: 10.0
        rebateCredits:
          type: boolean
          description: |
            Whether to apply rebate credits to total cost.
            If enabled, credit notes will be deducted from the Usage Account's total cost.
          default: false
          example: true
        lastTransactionDate:
          type: string
          format: date-time
          nullable: true
          description: Date and time of the last transaction
          example: "2025-01-15T14:20:00Z"
        totalUsage:
          type: number
          format: double
          description: Total usage amount for this account
          example: 5000.00
        totalDeposit:
          type: number
          format: double
          description: Total deposit/credit amount for this account
          example: -500.00
        fundsUtilization:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: Percentage of funds utilized
          example: 75.5
        createdAt:
          type: string
          format: date-time
          description: Account creation timestamp
          example: "2024-02-01T10:00:00Z"
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp
          example: "2025-01-15T14:20:00Z"

    CreateUsageAccountRequest:
      type: object
      required:
        - accountId
        - customer
        - payerAccountId
        - vatNumber
        - resellerDiscount
        - customerDiscount
      properties:
        accountId:
          type: string
          pattern: '^\d{12}$'
          description: 12-digit AWS usage account ID (must be unique)
          example: "987654321098"
        customer:
          type: string
          minLength: 1
          maxLength: 255
          description: Customer name for this usage account
          example: "Acme Corporation"
        payerAccountId:
          type: string
          pattern: '^\d{12}$'
          description: Parent AWS payer account ID (must exist)
          example: "123456789012"
        vatNumber:
          type: string
          minLength: 1
          maxLength: 50
          description: VAT identification number
          example: "DE123456789"
        resellerDiscount:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: Reseller discount percentage (0-100)
          example: 15.5
        customerDiscount:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: Customer discount percentage (0-100, must be ≤ resellerDiscount)
          example: 10.0
        rebateCredits:
          type: boolean
          description: Whether to apply rebate credits to total cost
          default: false
          example: true

    UpdateUsageAccountRequest:
      type: object
      description: |
        Update usage account configuration.
        Note: accountId and customer cannot be modified.
      properties:
        vatNumber:
          type: string
          minLength: 1
          maxLength: 50
          description: VAT identification number
        resellerDiscount:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: Reseller discount percentage
        customerDiscount:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: Customer discount percentage (must be ≤ resellerDiscount)
        rebateCredits:
          type: boolean
          description: Whether to apply rebate credits to total cost

    Pagination:
      type: object
      required:
        - page
        - limit
        - totalItems
        - totalPages
      properties:
        page:
          type: integer
          minimum: 1
          description: Current page number
          example: 1
        limit:
          type: integer
          minimum: 1
          maximum: 100
          description: Number of items per page
          example: 20
        totalItems:
          type: integer
          minimum: 0
          description: Total number of items
          example: 45
        totalPages:
          type: integer
          minimum: 0
          description: Total number of pages
          example: 3

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Error code for programmatic handling
              example: "VALIDATION_ERROR"
            message:
              type: string
              description: Human-readable error message
              example: "Validation failed"
            field:
              type: string
              description: Field that caused the error (if applicable)
              example: "customerDiscount"
            details:
              type: object
              description: Additional error details
              additionalProperties: true

  responses:
    BadRequest:
      description: Bad request - validation error or invalid parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error:
              code: "VALIDATION_ERROR"
              message: "Invalid request parameters"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error:
              code: "NOT_FOUND"
              message: "Account not found"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error:
              code: "INTERNAL_ERROR"
              message: "An unexpected error occurred"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT authentication token

security:
  - BearerAuth: []
